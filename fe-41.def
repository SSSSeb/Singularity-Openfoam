Bootstrap: docker
From: centos:7

%help
    This container image provides a FoamExtend-4.1 environment installed 
    with GCC and UCX enabled OpenMPI-4.

%labels
    Author Fatih Ertinaz
    Package FoamExtend-4.1

%post
    ### Install prerequisites
    yum groupinstall -y 'Development Tools' &&  \
    yum install -y wget git which cmake \
                   numactl-devel.x86_64 \
                   openssl-devel libuuid-devel

    ### Install third-party tools manually
    if [[ -d /tmp/tools ]] ; then rm -rf /tmp/tools ; fi
    mkdir -p /tmp/tools

    ### Install OpenMPI with UCX enabled
    cd /tmp/tools && mkdir ucx && cd ucx
    vrs=1.8.0
    wget https://github.com/openucx/ucx/releases/download/v1.8.0/ucx-$vrs.tar.gz
    tar xf ucx-$vrs.tar.gz && rm -f ucx-$vrs.tar.gz && cd ucx-$vrs
    mkdir build && cd build && ../configure --prefix=/opt/ucx-$vrs
    make && make install

    export UCX_DIR=/opt/ucx-1.8.0 >> $SINGULARITY_ENVIRONMENT
    export UCX_BIN=$UCX_DIR/bin >> $SINGULARITY_ENVIRONMENT
    export UCX_LIB=$UCX_DIR/lib >> $SINGULARITY_ENVIRONMENT
    export UCX_INC=$UCX_DIR/include >> $SINGULARITY_ENVIRONMENT

    export PATH=$UCX_BIN:$PATH >> $SINGULARITY_ENVIRONMENT
    export LD_LIBRARY_PATH=$UCX_LIB:$LD_LIBRARY_PATH >> $SINGULARITY_ENVIRONMENT

    cd /tmp/tools && mkdir openmpi && cd openmpi
    vrs=4.0.4
    wget https://download.open-mpi.org/release/open-mpi/v4.0/openmpi-${vrs}.tar.gz
    tar xf openmpi-${vrs}.tar.gz && rm -f openmpi-${vrs}.tar.gz
    cd openmpi-${vrs} && mkdir build-ucx && cd build-ucx 
    ../configure --with-ucx=/opt/ucx-1.8.0 --prefix=/opt/openmpi-${vrs}
    make all install
    make all clean

    export MPI_DIR=/opt/openmpi-4.0.4 >> $SINGULARITY_ENVIRONMENT
    export MPI_BIN=$MPI_DIR/bin >> $SINGULARITY_ENVIRONMENT
    export MPI_LIB=$MPI_DIR/lib >> $SINGULARITY_ENVIRONMENT
    export MPI_INC=$MPI_DIR/include >> $SINGULARITY_ENVIRONMENT

    export PATH=$MPI_BIN:$PATH >> $SINGULARITY_ENVIRONMENT
    export LD_LIBRARY_PATH=$MPI_LIB:$LD_LIBRARY_PATH >> $SINGULARITY_ENVIRONMENT

    export CPATH=$MPI_INC >> $SINGULARITY_ENVIRONMENT

    ### Metis
    cd /tmp/tools && mkdir metis && cd metis 
    wget http://downloads.sourceforge.net/project/foam-extend/ThirdParty/metis-5.1.0.tar.gz
    tar xf metis-5.1.0.tar.gz && rm -f metis-5.1.0.tar.gz && cd metis-5.1.0
    make config shared=1 prefix=/opt/metis-5.1.0 
    make && make install 
    make distclean

    export METIS_DIR=/opt/metis-5.1.0 >> $SINGULARITY_ENVIRONMENT
    export METIS_BIN=$METIS_DIR/bin >> $SINGULARITY_ENVIRONMENT
    export METIS_LIB=$METIS_DIR/lib >> $SINGULARITY_ENVIRONMENT
    export METIS_INC=$METIS_DIR/include >> $SINGULARITY_ENVIRONMENT

    export PATH=$METIS_BIN:$PATH >> $SINGULARITY_ENVIRONMENT
    export LD_LIBRARY_PATH=$METIS_LIB:$LD_LIBRARY_PATH >> $SINGULARITY_ENVIRONMENT
    export CPATH=$METIS_INC:$CPATH >> $SINGULARITY_ENVIRONMENT
    
    ### ParMGridGen: Does not support prefix option
    cd /opt && mkdir ParMGridGen && cd ParMGridGen
    wget http://downloads.sourceforge.net/project/foam-extend/ThirdParty/ParMGridGen-1.0.tar.gz
    tar xf ParMGridGen-1.0.tar.gz && rm -f ParMGridGen-1.0.tar.gz && cd ParMGridGen-1.0
    sed -i 's,LIBDIR = -L../.. \\,LIBDIR = -L../.. -L'"${MPI_LIB}"' \\,' Makefile.in
    make parallel
    
    export PARMGRIDGEN_DIR=/opt/ParMGridGen/ParMGridGen-1.0 >> $SINGULARITY_ENVIRONMENT
    export PARMGRIDGEN_BIN=$PARMGRIDGEN_DIR/bin >> $SINGULARITY_ENVIRONMENT
    export PARMGRIDGEN_LIB=$PARMGRIDGEN_DIR/lib >> $SINGULARITY_ENVIRONMENT
    export PARMGRIDGEN_INC=$PARMGRIDGEN_DIR/include >> $SINGULARITY_ENVIRONMENT

    export PATH=$PARMGRIDGEN_BIN:$PATH >> $SINGULARITY_ENVIRONMENT
    export LD_LIBRARY_PATH=$PARMGRIDGEN_LIB:$LD_LIBRARY_PATH >> $SINGULARITY_ENVIRONMENT

    ### Mesquite
    cd /tmp/tools && mkdir mesquite && cd mesquite
    wget https://software.sandia.gov/mesquite/mesquite-2.3.0.tar.gz 
    tar xf mesquite-2.3.0.tar.gz  && rm -f mesquite-2.3.0.tar.gz 
    cd mesquite-2.3.0 
    ./configure --prefix=/opt/mesquite-2.3.0
    make && make install

    export MESQUITE_DIR=/opt/mesquite-2.3.0 >> $SINGULARITY_ENVIRONMENT
    export MESQUITE_BIN=$MESQUITE_DIR/bin >> $SINGULARITY_ENVIRONMENT
    export MESQUITE_LIB=$MESQUITE_DIR/lib >> $SINGULARITY_ENVIRONMENT
    export MESQUITE_INC=$MESQUITE_DIR/include >> $SINGULARITY_ENVIRONMENT

    export PATH=$MESQUITE_BIN:$PATH >> $SINGULARITY_ENVIRONMENT
    export LD_LIBRARY_PATH=$MESQUITE_LIB:$LD_LIBRARY_PATH >> $SINGULARITY_ENVIRONMENT
    export CPATH=$MESQUITE_INC:$CPATH >> $SINGULARITY_ENVIRONMENT

    ### Scotch
    cd /tmp/tools && mkdir scotch && cd scotch
    wget http://downloads.sourceforge.net/project/foam-extend/ThirdParty/scotch_6.0.4.tar.gz
    tar xf scotch_6.0.4.tar.gz && rm -f scotch_6.0.4.tar.gz && cd scotch_6.0.4
    cd src && cp Make.inc/Makefile.inc.x86-64_pc_linux2.shlib Makefile.inc
    mkdir -p /opt/scotch-6.0.4
    make scotch   && make prefix=/opt/scotch-6.0.4 install
    make ptscotch && make prefix=/opt/scotch-6.0.4 install

    export SCOTCH_DIR=/opt/scotch-6.0.4 >> $SINGULARITY_ENVIRONMENT
    export SCOTCH_BIN=$SCOTCH_DIR/bin >> $SINGULARITY_ENVIRONMENT
    export SCOTCH_LIB=$SCOTCH_DIR/lib >> $SINGULARITY_ENVIRONMENT
    export SCOTCH_INC=$SCOTCH_DIR/include >> $SINGULARITY_ENVIRONMENT

    export PATH=$SCOTCH_BIN:$PATH >> $SINGULARITY_ENVIRONMENT
    export LD_LIBRARY_PATH=$SCOTCH_LIB:$LD_LIBRARY_PATH >> $SINGULARITY_ENVIRONMENT
    export CPATH=$SCOTCH_INC:$CPATH >> $SINGULARITY_ENVIRONMENT

    # Parmetis
    cd /tmp/tools && mkdir parmetis && cd parmetis
    wget http://glaros.dtc.umn.edu/gkhome/fetch/sw/parmetis/parmetis-4.0.3.tar.gz
    tar xf parmetis-4.0.3.tar.gz && rm -f parmetis-4.0.3.tar.gz && cd parmetis-4.0.3
    make config shared=1 prefix=/opt/parmetis-4.0.3 
    make && make install 
    
    export PARMETIS_DIR=/opt/parmetis-4.0.3 >> $SINGULARITY_ENVIRONMENT
    export PARMETIS_BIN=$PARMETIS_DIR/bin >> $SINGULARITY_ENVIRONMENT
    export PARMETIS_LIB=$PARMETIS_DIR/lib >> $SINGULARITY_ENVIRONMENT
    export PARMETIS_INC=$PARMETIS_DIR/include >> $SINGULARITY_ENVIRONMENT

    export PATH=$PARMETIS_BIN:$PATH >> $SINGULARITY_ENVIRONMENT
    export LD_LIBRARY_PATH=$PARMETIS_LIB:$LD_LIBRARY_PATH >> $SINGULARITY_ENVIRONMENT
    export CPATH=$PARMETIS_INC:$CPATH >> $SINGULARITY_ENVIRONMENT

    ## hwloc
    cd /tmp/tools && mkdir hwloc && cd hwloc
    wget http://www.open-mpi.org/software/hwloc/v2.0/downloads/hwloc-2.0.1.tar.gz
    tar xf hwloc-2.0.1.tar.gz && rm -f hwloc-2.0.1.tar.gz && cd hwloc-2.0.1
    ./configure --prefix=/opt/hwloc-2.0.1 && make && make install

    export HWLOC_DIR=/opt/hwloc-2.0.1 >> $SINGULARITY_ENVIRONMENT
    export HWLOC_BIN=$HWLOC_DIR/bin >> $SINGULARITY_ENVIRONMENT
    export HWLOC_LIB=$HWLOC_DIR/lib >> $SINGULARITY_ENVIRONMENT
    export HWLOC_INC=$HWLOC_DIR/include >> $SINGULARITY_ENVIRONMENT

    export PATH=$HWLOC_BIN:$PATH >> $SINGULARITY_ENVIRONMENT
    export LD_LIBRARY_PATH=$HWLOC_LIB:$LD_LIBRARY_PATH >> $SINGULARITY_ENVIRONMENT
    export CPATH=$HWLOC_INC:$CPATH >> $SINGULARITY_ENVIRONMENT

    ### OpenFOAM version
    prj=foam
    fork=extend
    vrs=4.1
    pkg=$prj-$fork-$vrs

    base=/opt/foam
    mkdir -p $base && cd $base
    git clone git://git.code.sf.net/p/foam-extend/$pkg $pkg
    cd $pkg

    sed -i 's,foamInstall=$HOME\/$WM_PROJECT,foamInstall='"$base"',' etc/bashrc 

    cp etc/prefs.sh-EXAMPLE etc/prefs.sh

    ### Change OpenMPI in prefs.sh
    sed -i 's/#export WM_MPLIB=SYSTEMOPENMPI/export WM_MPLIB=SYSTEMOPENMPI/' etc/prefs.sh
    sed -i 's,#export OPENMPI_DIR=path_to_system_installed_openmpi,export OPENMPI_DIR='"$MPI_DIR"',' etc/prefs.sh
    sed -i 's,#export OPENMPI_BIN_DIR="$OPENMPI_DIR"\/bin,export OPENMPI_BIN_DIR='"$MPI_BIN"',' etc/prefs.sh

    ### Mesquite
    sed -i 's/#export MESQUITE_SYSTEM=1/export MESQUITE_SYSTEM=1/' etc/prefs.sh
    sed -i 's,#export MESQUITE_DIR=path_to_system_installed_mesquite,export MESQUITE_DIR='"$MESQUITE_DIR"',' etc/prefs.sh
    sed -i 's,#export MESQUITE_BIN_DIR=$MESQUITE_DIR/bin,export MESQUITE_BIN_DIR=$MESQUITE_BIN,' etc/prefs.sh
    sed -i 's,#export MESQUITE_LIB_DIR=$MESQUITE_DIR/lib,export MESQUITE_LIB_DIR=$MESQUITE_LIB,' etc/prefs.sh
    sed -i 's,#export MESQUITE_INCLUDE_DIR=$MESQUITE_DIR/include,export MESQUITE_INCLUDE_DIR=$MESQUITE_INC,' etc/prefs.sh

    ### Metis
    sed -i 's/#export METIS_SYSTEM=1/export METIS_SYSTEM=1/' etc/prefs.sh
    sed -i 's,#export METIS_DIR=path_to_system_installed_metis,export METIS_DIR='"$METIS_DIR"',' etc/prefs.sh
    sed -i 's,#export METIS_BIN_DIR=$METIS_DIR/bin,export METIS_BIN_DIR=$METIS_BIN,' etc/prefs.sh
    sed -i 's,#export METIS_LIB_DIR=$METIS_DIR/lib,export METIS_LIB_DIR=$METIS_LIB,' etc/prefs.sh
    sed -i 's,#export METIS_INCLUDE_DIR=$METIS_DIR/include,export METIS_INCLUDE_DIR=$METIS_INC,' etc/prefs.sh

    ### Parmetis
    sed -i 's/#export PARMETIS_SYSTEM=1/export PARMETIS_SYSTEM=1/' etc/prefs.sh
    sed -i 's,#export PARMETIS_DIR=path_to_system_installed_parmetis,export PARMETIS_DIR='"$PARMETIS_DIR"',' etc/prefs.sh
    sed -i 's,#export PARMETIS_BIN_DIR=$PARMETIS_DIR/bin,export PARMETIS_BIN_DIR=$PARMETIS_BIN,' etc/prefs.sh
    sed -i 's,#export PARMETIS_LIB_DIR=$PARMETIS_DIR/lib,export PARMETIS_LIB_DIR=$PARMETIS_LIB,' etc/prefs.sh
    sed -i 's,#export PARMETIS_INCLUDE_DIR=$PARMETIS_DIR/include,export PARMETIS_INCLUDE_DIR=$PARMETIS_INC,' etc/prefs.sh

    ### ParMGridgen
    sed -i 's/#export PARMGRIDGEN_SYSTEM=1/export PARMGRIDGEN_SYSTEM=1/' etc/prefs.sh
    sed -i 's,#export PARMGRIDGEN_DIR=path_to_system_installed_parmgridgen,export PARMGRIDGEN_DIR='"$PARMGRIDGEN_DIR"',' etc/prefs.sh
    sed -i 's,#export PARMGRIDGEN_BIN_DIR=$PARMGRIDGEN_DIR/bin,export PARMGRIDGEN_BIN_DIR=$PARMGRIDGEN_BIN,' etc/prefs.sh
    sed -i 's,#export PARMGRIDGEN_LIB_DIR=$PARMGRIDGEN_DIR/lib,export PARMGRIDGEN_LIB_DIR=$MESQUITE_LIB,' etc/prefs.sh
    sed -i 's,#export PARMGRIDGEN_INCLUDE_DIR=$PARMGRIDGEN_DIR/include,export PARMGRIDGEN_INCLUDE_DIR=$MESQUITE_INC,' etc/prefs.sh

    ### Scotch
    sed -i 's/#export SCOTCH_SYSTEM=1/export SCOTCH_SYSTEM=1/' etc/prefs.sh
    sed -i 's,#export SCOTCH_DIR=path_to_system_installed_scotch,export SCOTCH_DIR='"$SCOTCH_DIR"',' etc/prefs.sh
    sed -i 's,#export SCOTCH_BIN_DIR=$SCOTCH_DIR/bin,export SCOTCH_BIN_DIR=$SCOTCH_BIN,' etc/prefs.sh
    sed -i 's,#export SCOTCH_LIB_DIR=$SCOTCH_DIR/lib,export SCOTCH_LIB_DIR=$SCOTCH_LIB,' etc/prefs.sh
    sed -i 's,#export SCOTCH_INCLUDE_DIR=$SCOTCH_DIR/include,export SCOTCH_INCLUDE_DIR=$SCOTCH_INC,' etc/prefs.sh

    ### hwloc
    sed -i 's/#export HWLOC_SYSTEM=1/export HWLOC_SYSTEM=1/' etc/prefs.sh
    sed -i 's,#export HWLOC_DIR=path_to_system_installed_hwloc,export HWLOC_DIR='"$HWLOC_DIR"',' etc/prefs.sh
    sed -i 's,#export HWLOC_BIN_DIR=$HWLOC_DIR/bin,export HWLOC_BIN_DIR=$HWLOC_BIN,' etc/prefs.sh
    sed -i 's,#export HWLOC_LIB_DIR=$HWLOC_DIR/lib,export HWLOC_LIB_DIR=$HWLOC_LIB,' etc/prefs.sh
    sed -i 's,#export HWLOC_INCLUDE_DIR=$HWLOC_DIR/include,export HWLOC_INCLUDE_DIR=$HWLOC_INC,' etc/prefs.sh

    export OPENMPI_DIR=$MPI_DIR >> $SINGULARITY_ENVIRONMENT

    ### Source OF
    set +eu
    . etc/bashrc 

    ### Compile and install
    ./Allwmake

    rmoall src applications
    rmdepall
    find src applications -name "linux*" | grep "/Make/" | xargs rm -rf

    rm -rf /tmp/tools

    strip $FOAM_APPBIN/*

    ### Source bashrc at runtime
    echo '. /opt/foam/foam-extend-4.1/etc/bashrc' >> $SINGULARITY_ENVIRONMENT

%environment
    export UCX_DIR=/opt/ucx-1.8.0
    export UCX_BIN=$UCX_DIR/bin
    export UCX_LIB=$UCX_DIR/lib
    export UCX_INC=$UCX_DIR/include

    export PATH=$UCX_BIN:$PATH
    export LD_LIBRARY_PATH=$UCX_LIB:$LD_LIBRARY_PATH

    export MPI_DIR=/opt/openmpi-4.0.4
    export MPI_BIN=$MPI_DIR/bin
    export MPI_LIB=$MPI_DIR/lib
    export MPI_INC=$MPI_DIR/include

    export PATH=$MPI_BIN:$PATH
    export LD_LIBRARY_PATH=$MPI_LIB:$LD_LIBRARY_PATH

    export METIS_DIR=/opt/metis-5.1.0
    export METIS_BIN=$METIS_DIR/bin
    export METIS_LIB=$METIS_DIR/lib
    export METIS_INC=$METIS_DIR/include

    export PATH=$METIS_BIN:$PATH
    export LD_LIBRARY_PATH=$METIS_LIB:$LD_LIBRARY_PATH

    export PARMGRIDGEN_DIR=/opt/ParMGridGen/ParMGridGen-1.0
    export PARMGRIDGEN_BIN=$PARMGRIDGEN_DIR/bin
    export PARMGRIDGEN_LIB=$PARMGRIDGEN_DIR/lib
    export PARMGRIDGEN_INC=$PARMGRIDGEN_DIR/include

    export PATH=$PARMGRIDGEN_BIN:$PATH
    export LD_LIBRARY_PATH=$PARMGRIDGEN_LIB:$LD_LIBRARY_PATH

    export MESQUITE_DIR=/opt/mesquite-2.3.0
    export MESQUITE_BIN=$MESQUITE_DIR/bin
    export MESQUITE_LIB=$MESQUITE_DIR/lib
    export MESQUITE_INC=$MESQUITE_DIR/include

    export PATH=$MESQUITE_BIN:$PATH
    export LD_LIBRARY_PATH=$MESQUITE_LIB:$LD_LIBRARY_PATH

    export SCOTCH_DIR=/opt/scotch-6.0.4
    export SCOTCH_BIN=$SCOTCH_DIR/bin
    export SCOTCH_LIB=$SCOTCH_DIR/lib
    export SCOTCH_INC=$SCOTCH_DIR/include

    export PATH=$SCOTCH_BIN:$PATH
    export LD_LIBRARY_PATH=$SCOTCH_LIB:$LD_LIBRARY_PATH

    export PARMETIS_DIR=/opt/parmetis-4.0.3
    export PARMETIS_BIN=$PARMETIS_DIR/bin
    export PARMETIS_LIB=$PARMETIS_DIR/lib
    export PARMETIS_INC=$PARMETIS_DIR/include

    export PATH=$PARMETIS_BIN:$PATH
    export LD_LIBRARY_PATH=$PARMETIS_LIB:$LD_LIBRARY_PATH

    export HWLOC_DIR=/opt/hwloc-2.0.1
    export HWLOC_BIN=$HWLOC_DIR/bin
    export HWLOC_LIB=$HWLOC_DIR/lib
    export HWLOC_INC=$HWLOC_DIR/include

    export PATH=$HWLOC_BIN:$PATH
    export LD_LIBRARY_PATH=$HWLOC_LIB:$LD_LIBRARY_PATH

    export CPATH=$HWLOC_INC:$PARMETIS_INC:$SCOTCH_INC:$METIS_INC:$MPI_INC:$UCX_INC
%runscript
    echo
    echo "Foam-Extend installation is available under $WM_PROJECT_DIR"
    echo
